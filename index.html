<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Physical Intelligence — Strava Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<style>
  :root {
    --orange: #FC4C02;
    --orange-dim: #ff6a2e22;
    --black: #0a0a0a;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #2a2a2a;
    --text: #e8e8e8;
    --muted: #666;
    --green: #00e5a0;
    --mono: 'DM Mono', monospace;
    --display: 'Bebas Neue', sans-serif;
    --sans: 'DM Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--black);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grain overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  /* Header */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 40px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: rgba(10,10,10,0.95);
    backdrop-filter: blur(12px);
    z-index: 100;
  }

  .logo {
    font-family: var(--display);
    font-size: 22px;
    letter-spacing: 3px;
    color: var(--orange);
  }

  .logo span { color: var(--text); }

  .header-tag {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* Auth section */
  #auth-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    padding: 40px;
    text-align: center;
    animation: fadeUp 0.6s ease forwards;
  }

  .auth-eyebrow {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--orange);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 24px;
  }

  .auth-title {
    font-family: var(--display);
    font-size: clamp(52px, 8vw, 100px);
    line-height: 0.92;
    letter-spacing: 2px;
    margin-bottom: 24px;
    background: linear-gradient(135deg, #fff 0%, #888 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .auth-sub {
    font-size: 15px;
    color: var(--muted);
    max-width: 460px;
    line-height: 1.7;
    margin-bottom: 48px;
    font-weight: 300;
  }

  .config-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    width: 100%;
    max-width: 480px;
    text-align: left;
    margin-bottom: 24px;
  }

  .config-box h3 {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  .field {
    margin-bottom: 16px;
  }

  .field label {
    display: block;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  .field input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 14px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
  }

  .field input:focus { border-color: var(--orange); }
  .field input::placeholder { color: var(--muted); }

  .btn-primary {
    width: 100%;
    background: var(--orange);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 14px 24px;
    font-family: var(--display);
    font-size: 18px;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }

  .btn-primary:hover {
    background: #e04400;
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(252,76,2,0.3);
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .hint {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    text-align: center;
    line-height: 1.6;
  }

  .hint a { color: var(--orange); text-decoration: none; }
  .hint a:hover { text-decoration: underline; }

  /* Token input section */
  #token-section {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    padding: 40px;
    text-align: center;
  }

  /* Dashboard */
  #dashboard {
    display: none;
    padding: 40px;
    max-width: 1400px;
    margin: 0 auto;
    animation: fadeUp 0.5s ease forwards;
  }

  .dashboard-header {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    margin-bottom: 40px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
    gap: 16px;
  }

  .athlete-info h1 {
    font-family: var(--display);
    font-size: clamp(36px, 5vw, 64px);
    letter-spacing: 2px;
    line-height: 1;
    margin-bottom: 6px;
  }

  .athlete-info p {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .status-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    background: var(--green);
    border-radius: 50%;
    margin-right: 8px;
    animation: pulse 2s infinite;
  }

  /* Stats grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .stat-card:hover { border-color: var(--orange); }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--orange), transparent);
  }

  .stat-label {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  .stat-value {
    font-family: var(--display);
    font-size: 42px;
    letter-spacing: 1px;
    line-height: 1;
    color: var(--text);
  }

  .stat-unit {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--muted);
    margin-top: 4px;
  }

  /* Two column layout */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 24px;
  }

  @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

  /* Panel */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 28px;
  }

  .panel-title {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .panel-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* Activity list */
  .activity-item {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    align-items: center;
    gap: 16px;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
    transition: all 0.15s;
  }

  .activity-item:last-child { border-bottom: none; }
  .activity-item:hover { padding-left: 8px; }

  .activity-name {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .activity-date {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
  }

  .activity-dist {
    font-family: var(--display);
    font-size: 20px;
    color: var(--orange);
    white-space: nowrap;
  }

  .activity-pace {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    text-align: right;
    white-space: nowrap;
  }

  /* Chart */
  .chart-area {
    height: 180px;
    position: relative;
    margin-top: 8px;
  }

  canvas { width: 100% !important; }

  /* AI Insight panel */
  .insight-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 28px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
  }

  .insight-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--green), var(--orange));
  }

  .insight-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }

  .ai-badge {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--green);
    border: 1px solid var(--green);
    border-radius: 4px;
    padding: 3px 8px;
    text-transform: uppercase;
  }

  .insight-title {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  #insight-text {
    font-size: 15px;
    line-height: 1.75;
    color: var(--text);
    font-weight: 300;
    white-space: pre-wrap;
  }

  .insight-loading {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--muted);
    font-family: var(--mono);
    font-size: 12px;
  }

  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--orange);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .btn-insight {
    background: transparent;
    border: 1px solid var(--green);
    color: var(--green);
    border-radius: 6px;
    padding: 8px 16px;
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 16px;
  }

  .btn-insight:hover {
    background: var(--green);
    color: var(--black);
  }

  /* Month chart bars */
  .bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 4px;
    height: 120px;
    margin-top: 16px;
  }

  .bar-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    height: 100%;
    justify-content: flex-end;
  }

  .bar {
    width: 100%;
    background: var(--orange);
    border-radius: 3px 3px 0 0;
    transition: height 0.8s cubic-bezier(0.16,1,0.3,1);
    min-height: 2px;
    opacity: 0.8;
  }

  .bar:hover { opacity: 1; }

  .bar-label {
    font-family: var(--mono);
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 0.5px;
  }

  /* PR table */
  .pr-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .pr-item {
    background: var(--surface2);
    border-radius: 8px;
    padding: 16px;
    border-left: 2px solid var(--orange);
  }

  .pr-dist { font-family: var(--mono); font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .pr-time { font-family: var(--display); font-size: 28px; color: var(--text); }
  .pr-date { font-family: var(--mono); font-size: 10px; color: var(--muted); margin-top: 4px; }

  /* Loading overlay */
  #loading {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--black);
    z-index: 500;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
  }

  .load-text {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--muted);
    letter-spacing: 2px;
  }

  .load-bar {
    width: 200px;
    height: 2px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }

  .load-fill {
    height: 100%;
    background: var(--orange);
    border-radius: 2px;
    animation: loadProgress 2s ease forwards;
  }

  /* Error */
  .error-msg {
    background: rgba(255,60,60,0.1);
    border: 1px solid rgba(255,60,60,0.3);
    border-radius: 8px;
    padding: 12px 16px;
    font-family: var(--mono);
    font-size: 12px;
    color: #ff6b6b;
    margin-top: 12px;
    display: none;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @keyframes loadProgress {
    from { width: 0; }
    to { width: 100%; }
  }

  .full-width { grid-column: 1 / -1; }
  .tag { display: inline-block; background: var(--orange-dim); color: var(--orange); font-family: var(--mono); font-size: 10px; letter-spacing: 1px; padding: 2px 8px; border-radius: 3px; margin-right: 6px; }

  #period-filter:hover, #period-filter:focus { border-color: var(--orange); }
  #period-filter option { background: var(--surface2); }

  /* Map panel */
  #map {
    height: 320px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--surface2);
  }
  .map-meta { display: flex; gap: 24px; margin-top: 16px; flex-wrap: wrap; }
  .map-stat-label { font-family: var(--mono); font-size: 10px; color: var(--muted); letter-spacing: 1px; margin-bottom: 2px; }
  .map-stat-val { font-family: var(--display); font-size: 28px; color: var(--text); }
  .map-stat-unit { font-family: var(--mono); font-size: 11px; color: var(--muted); }
  .leaflet-tile { filter: invert(1) hue-rotate(180deg) brightness(0.85) contrast(1.1); }

  /* Tab navigation */
  .tab-nav {
    display: none;
    gap: 0;
    border-bottom: 1px solid var(--border);
    padding: 0 40px;
    background: rgba(10,10,10,0.95);
    position: sticky;
    top: 73px;
    z-index: 99;
    backdrop-filter: blur(12px);
  }

  .tab-btn {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    padding: 16px 24px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: -1px;
  }

  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { color: var(--orange); border-bottom-color: var(--orange); }

  /* Heatmap tab */
  #heatmap-tab {
    display: none;
    width: 100%;
    height: calc(100vh - 130px);
    position: relative;
    overflow: hidden;
  }

  #heatmap {
    position: absolute;
    inset: 0;
    width: 100% !important;
    height: 100% !important;
  }

  /* Dark tiles for heatmap — subtle darkening only, don't wash out heat layer */
  #heatmap .leaflet-tile { filter: brightness(0.45) saturate(0.3); }
  #heatmap .leaflet-heatmap-layer { z-index: 999 !important; opacity: 1 !important; }

  .heatmap-overlay {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 500;
    background: rgba(10,10,10,0.88);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 20px 24px;
    backdrop-filter: blur(12px);
    min-width: 200px;
  }

  .heatmap-overlay h2 {
    font-family: var(--display);
    font-size: 28px;
    letter-spacing: 2px;
    color: var(--text);
    margin-bottom: 4px;
  }

  .heatmap-overlay p {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
    margin-bottom: 16px;
  }

  .heat-legend {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
  }

  .heat-gradient {
    width: 100px;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(90deg, #0000ff, #00ffff, #00ff00, #ffff00, #ff0000);
  }

  .heat-legend-label {
    font-family: var(--mono);
    font-size: 9px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .heatmap-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
  }

  .heatmap-stat:last-child { border-bottom: none; }
  .heatmap-stat-label { font-family: var(--mono); font-size: 10px; color: var(--muted); letter-spacing: 1px; }
  .heatmap-stat-val { font-family: var(--display); font-size: 20px; color: var(--orange); }

  .heat-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 600;
    text-align: center;
    background: rgba(10,10,10,0.9);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px 48px;
  }

  .heat-loading h3 {
    font-family: var(--display);
    font-size: 32px;
    letter-spacing: 3px;
    color: var(--orange);
    margin-bottom: 12px;
  }

  .heat-loading p {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  .heat-progress {
    width: 200px;
    height: 2px;
    background: var(--border);
    border-radius: 2px;
    margin: 16px auto 0;
    overflow: hidden;
  }

  .heat-progress-fill {
    height: 100%;
    background: var(--orange);
    border-radius: 2px;
    transition: width 0.3s ease;
    width: 0%;
  }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div style="font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:4px;color:#FC4C02;">LOADING</div>
  <div class="load-bar"><div class="load-fill"></div></div>
  <div class="load-text" id="load-status">CONNECTING TO STRAVA API</div>
</div>

<!-- Header -->
<header>
  <div class="logo">PHYSICAL<span>INTEL</span></div>
  <div class="header-tag">STRAVA × CLAUDE AI — SENSOR DASHBOARD v1.0</div>
</header>

<!-- Tab Navigation (shown after login) -->
<nav class="tab-nav" id="tab-nav">
  <button class="tab-btn active" onclick="switchTab('dashboard')">⬡ Dashboard</button>
  <button class="tab-btn" onclick="switchTab('heatmap')">◈ Route Heatmap</button>
  <button class="tab-btn" onclick="switchTab('anomaly')">⚠ Anomaly Detector</button>
  <button class="tab-btn" onclick="switchTab('apihealth')">◉ API Health</button>
  <button class="tab-btn" onclick="switchTab('goals')">◎ Goal Tracker</button>
</nav>

<!-- Heatmap Tab -->
<div id="heatmap-tab">
  <div id="heatmap-loading" class="heat-loading">
    <h3>MAPPING ROUTES</h3>
    <p id="heat-status">Decoding polylines...</p>
    <div class="heat-progress"><div class="heat-progress-fill" id="heat-progress-fill"></div></div>
  </div>
  <div id="heatmap"></div>
  <div class="heatmap-overlay" id="heatmap-overlay" style="display:none">
    <h2>ROUTE OVERLAY</h2>
    <p id="heat-subtitle">Last 100 runs overlaid</p>
    <div id="heat-stats"></div>
    <div class="heat-legend">
      <span class="heat-legend-label">RARE</span>
      <div class="heat-gradient"></div>
      <span class="heat-legend-label">FREQUENT</span>
    </div>
  </div>
</div>

<!-- Anomaly Detector Tab -->
<div id="anomaly-tab" style="display:none;padding:40px;max-width:1400px;margin:0 auto;">
  <div style="display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:16px;">
    <div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--orange);letter-spacing:3px;margin-bottom:8px;">● LIVE SENSOR ANALYSIS</div>
      <h2 style="font-family:var(--display);font-size:48px;letter-spacing:2px;line-height:1;">ANOMALY DETECTOR</h2>
      <p style="font-family:var(--mono);font-size:11px;color:var(--muted);margin-top:6px;">Claude AI monitors your run data for unusual patterns — like an enterprise sensor platform</p>
    </div>
    <button class="btn-insight" onclick="runAnomalyDetection()" id="anomaly-run-btn" style="border-color:var(--orange);color:var(--orange);">▶ RUN ANALYSIS</button>
  </div>
  <div id="anomaly-loading" style="display:none;align-items:center;gap:12px;font-family:var(--mono);font-size:12px;color:var(--muted);margin-bottom:24px;">
    <div class="spinner"></div><span id="anomaly-status">Analysing sensor data...</span>
  </div>
  <div id="anomaly-results"></div>
  <div id="anomaly-empty" style="text-align:center;padding:80px;font-family:var(--mono);font-size:12px;color:var(--muted);">
    Click RUN ANALYSIS to scan your last 30 runs for anomalies using Claude AI.
  </div>
</div>

<!-- API Health Monitor Tab -->
<div id="apihealth-tab" style="display:none;padding:40px;max-width:1400px;margin:0 auto;">
  <div style="display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:16px;">
    <div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--green);letter-spacing:3px;margin-bottom:8px;"><span class="status-dot"></span>LIVE MONITORING</div>
      <h2 style="font-family:var(--display);font-size:48px;letter-spacing:2px;line-height:1;">API HEALTH MONITOR</h2>
      <p style="font-family:var(--mono);font-size:11px;color:var(--muted);margin-top:6px;">Real-time Strava API performance — response times, rate limits, endpoint status</p>
    </div>
    <button class="btn-insight" onclick="runHealthCheck()" style="border-color:var(--green);color:var(--green);">↻ REFRESH</button>
  </div>
  <div id="health-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px;"></div>
  <div class="two-col" style="margin-bottom:32px;">
    <div class="panel">
      <div class="panel-title">Endpoint Response Times</div>
      <div id="endpoint-list"></div>
    </div>
    <div class="panel">
      <div class="panel-title">Request Log</div>
      <div id="request-log" style="max-height:300px;overflow-y:auto;"></div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-title">Rate Limit Usage</div>
    <div id="rate-limit-display" style="padding:8px 0;"></div>
  </div>
</div>

<!-- Goal Tracker Tab -->
<div id="goals-tab" style="display:none;padding:40px;max-width:1400px;margin:0 auto;">
  <div style="margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid var(--border);">
    <div style="font-family:var(--mono);font-size:11px;color:var(--orange);letter-spacing:3px;margin-bottom:8px;">● TIME-TO-VALUE TRACKER</div>
    <h2 style="font-family:var(--display);font-size:48px;letter-spacing:2px;line-height:1;">GOAL TRACKER</h2>
    <p style="font-family:var(--mono);font-size:11px;color:var(--muted);margin-top:6px;">Set a race goal and see your projected finish time based on current training trends</p>
  </div>

  <!-- Goal setter -->
  <div class="panel" style="margin-bottom:24px;">
    <div class="panel-title">Set Your Goal</div>
    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;margin-top:8px;">
      <div class="field" style="margin:0;flex:1;min-width:160px;">
        <label>RACE DISTANCE</label>
        <select id="goal-distance" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:13px;padding:10px 14px;border-radius:6px;outline:none;">
          <option value="5">5K</option>
          <option value="10">10K</option>
          <option value="21.1">Half Marathon</option>
          <option value="42.2" selected>Marathon</option>
        </select>
      </div>
      <div class="field" style="margin:0;flex:1;min-width:160px;">
        <label>GOAL DATE</label>
        <input type="date" id="goal-date" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:13px;padding:10px 14px;border-radius:6px;outline:none;">
      </div>
      <div class="field" style="margin:0;flex:1;min-width:160px;">
        <label>TARGET FINISH TIME (optional)</label>
        <input type="text" id="goal-target" placeholder="e.g. 3:45:00" style="width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:13px;padding:10px 14px;border-radius:6px;outline:none;">
      </div>
      <button class="btn-primary" onclick="calculateGoal()" style="width:auto;padding:11px 28px;flex-shrink:0;">CALCULATE →</button>
    </div>
  </div>

  <div id="goal-results" style="display:none;">
    <!-- Projection stats -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px;" id="goal-stats"></div>
    <div class="two-col" style="margin-bottom:24px;">
      <div class="panel">
        <div class="panel-title">Pace Trend (Last 20 Runs)</div>
        <canvas id="pace-trend-chart" height="220"></canvas>
      </div>
      <div class="panel">
        <div class="panel-title">Weekly Mileage Trend</div>
        <canvas id="weekly-chart" height="220"></canvas>
      </div>
    </div>
    <div class="panel" style="margin-bottom:40px;">
      <div class="panel-title">AI Training Plan Recommendation</div>
      <div id="goal-ai-text" style="font-size:14px;line-height:1.75;color:var(--text);font-weight:300;padding-top:4px;"></div>
    </div>
  </div>
</div>

<!-- Auth Section -->
<div id="auth-section">
  <div class="auth-eyebrow">● Physical World Data Platform</div>
  <h1 class="auth-title">YOUR BODY<br>AS A<br>SENSOR</h1>
  <p class="auth-sub">Connect your Strava account to transform your real-world movement data into AI-powered intelligence — pace trends, recovery patterns, and predictive insights.</p>

  <div class="config-box">
    <h3>Strava API Configuration</h3>
    <div class="field">
      <label>CLIENT ID</label>
      <input type="text" id="client-id" placeholder="e.g. 123456">
    </div>
    <div class="field">
      <label>CLIENT SECRET</label>
      <input type="password" id="client-secret" placeholder="Your Strava app client secret">
    </div>
    <button class="btn-primary" id="auth-btn" onclick="startAuth()">CONNECT TO STRAVA →</button>
    <div class="error-msg" id="auth-error"></div>
  </div>

  <div class="hint">
    Don't have an API app yet? <a href="https://www.strava.com/settings/api" target="_blank">Create one at strava.com/settings/api</a><br>
    Set the Authorization Callback Domain to <strong>localhost</strong> or your domain.
  </div>
</div>

<!-- Token exchange section (after OAuth redirect) -->
<div id="token-section">
  <div class="auth-eyebrow">● Almost there</div>
  <h1 style="font-family:'Bebas Neue',sans-serif;font-size:64px;letter-spacing:2px;margin-bottom:24px;">FINALISE<br>CONNECTION</h1>
  <p style="color:var(--muted);margin-bottom:32px;font-size:14px;max-width:420px;line-height:1.7;">Strava redirected you back with an authorization code. Enter your credentials below to complete the connection.</p>

  <div class="config-box">
    <h3>Complete Authentication</h3>
    <div class="field">
      <label>CLIENT ID</label>
      <input type="text" id="t-client-id" placeholder="Your Strava Client ID">
    </div>
    <div class="field">
      <label>CLIENT SECRET</label>
      <input type="password" id="t-client-secret" placeholder="Your Strava Client Secret">
    </div>
    <div class="field">
      <label>AUTHORIZATION CODE <span style="color:var(--orange)">(auto-filled if redirected)</span></label>
      <input type="text" id="t-auth-code" placeholder="Code from Strava redirect URL">
    </div>
    <button class="btn-primary" onclick="exchangeToken()">LOAD MY DATA →</button>
    <div class="error-msg" id="token-error"></div>
  </div>

  <p class="hint">The auth code from Strava expires in minutes — complete this quickly.</p>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <div class="dashboard-header">
    <div class="athlete-info">
      <h1 id="athlete-name">ATHLETE</h1>
      <p><span class="status-dot"></span><span id="athlete-meta">Loading...</span></p>
    </div>
    <div style="text-align:right">
      <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:1px;" id="last-updated"></div>
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px;justify-content:flex-end;">
        <span class="tag">STRAVA API</span>
        <span class="tag">CLAUDE AI</span>
        <span class="tag">PHYSICAL DATA</span>
        <button onclick="logout()" style="background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;padding:3px 10px;border-radius:4px;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='#ff4444';this.style.color='#ff4444'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">LOGOUT</button>
      </div>
    </div>
  </div>

  <!-- Time Period Filter -->
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
    <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;">Filter Period</div>
    <select id="period-filter" onchange="applyFilter()" style="
      background:var(--surface);
      border:1px solid var(--border);
      color:var(--text);
      font-family:'DM Mono',monospace;
      font-size:11px;
      letter-spacing:1px;
      padding:8px 14px;
      border-radius:6px;
      outline:none;
      cursor:pointer;
      transition:border-color 0.2s;
    ">
      <option value="all">All Time</option>
      <option value="ytd">Year to Date</option>
      <option value="year">Last Year</option>
      <option value="month">Last Month</option>
      <option value="week">Last Week</option>
      <option value="thisweek">This Week</option>
    </select>
    <div id="filter-count" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:1px;"></div>
  </div>

  <!-- Key Stats -->
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Activities</div>
      <div class="stat-value" id="stat-count">—</div>
      <div class="stat-unit">all time runs</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Distance</div>
      <div class="stat-value" id="stat-dist">—</div>
      <div class="stat-unit">miles</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Elevation</div>
      <div class="stat-value" id="stat-elev">—</div>
      <div class="stat-unit">feet climbed</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Time</div>
      <div class="stat-value" id="stat-time">—</div>
      <div class="stat-unit">hours moving</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Avg Pace</div>
      <div class="stat-value" id="stat-pace">—</div>
      <div class="stat-unit">min/mile average</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Longest Run</div>
      <div class="stat-value" id="stat-longest">—</div>
      <div class="stat-unit">miles</div>
    </div>
  </div>

  <!-- AI Insight -->
  <div class="insight-panel">
    <div class="insight-header">
      <span class="ai-badge">AI INSIGHT</span>
      <span class="insight-title">Physical Intelligence Analysis</span>
    </div>
    <div id="insight-text"><div class="insight-loading"><div class="spinner"></div>Analysing your movement data...</div></div>
    <button class="btn-insight" onclick="getInsight()" id="insight-btn" style="display:none">↻ REGENERATE INSIGHT</button>
  </div>

  <!-- Most Recent Run Map -->
  <div class="panel" style="margin-bottom:24px" id="map-panel">
    <div class="panel-title">Most Recent Run</div>
    <div id="map"></div>
    <div class="map-meta" id="map-meta"></div>
  </div>

  <!-- Charts + Recent -->
  <div class="two-col">
    <div class="panel">
      <div class="panel-title">Monthly Distance (mi)</div>
      <div class="bar-chart" id="month-bars"></div>
    </div>
    <div class="panel">
      <div class="panel-title">Recent Activities</div>
      <div id="activity-list"></div>
    </div>
  </div>

  <!-- PRs -->
  <div class="panel" style="margin-bottom:40px">
    <div class="panel-title">Best Efforts</div>
    <div class="pr-grid" id="pr-grid">
      <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);">Loading best efforts...</div>
    </div>
  </div>

  <!-- Temperature vs Pace -->
  <div class="panel" style="margin-bottom:40px" id="temp-panel">
    <div class="panel-title">Temperature vs Pace Analysis</div>
    <div id="temp-loading" style="display:flex;align-items:center;gap:12px;padding:24px 0;font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);">
      <div class="spinner"></div>
      <span id="temp-status">Fetching weather data for your runs...</span>
    </div>
    <div id="temp-content" style="display:none">
      <!-- Summary stats row -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px" id="temp-stats-row"></div>
      <!-- Charts side by side -->
      <div class="two-col" style="margin-bottom:0">
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:2px;margin-bottom:12px">SCATTER — EACH RUN</div>
          <canvas id="scatter-chart" height="260"></canvas>
        </div>
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:2px;margin-bottom:12px">TREND — AVG PACE BY TEMP RANGE</div>
          <canvas id="trend-chart" height="260"></canvas>
        </div>
      </div>
      <div id="temp-insight" style="margin-top:20px;padding:16px;background:var(--surface2);border-radius:8px;font-size:13px;line-height:1.7;color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.5px;"></div>
    </div>
    <div id="temp-error" style="display:none;font-family:'DM Mono',monospace;font-size:12px;color:#ff6b6b;padding:16px 0;"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
let accessToken = null;
let allActivities = [];
let athleteData = null;

// ─── On Load: check for OAuth code ───────────────────────────────────────────
window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  if (code) {
    document.getElementById('auth-section').style.display = 'none';
    document.getElementById('token-section').style.display = 'flex';
    document.getElementById('t-auth-code').value = code;
    // restore saved creds
    const saved = JSON.parse(localStorage.getItem('strava_creds') || '{}');
    if (saved.id) document.getElementById('t-client-id').value = saved.id;
    if (saved.secret) document.getElementById('t-client-secret').value = saved.secret;
  } else {
    // Auto-fill creds on the main auth page too
    const saved = JSON.parse(localStorage.getItem('strava_creds') || '{}');
    if (saved.id) document.getElementById('client-id').value = saved.id;
    if (saved.secret) document.getElementById('client-secret').value = saved.secret;
  }
  // check for saved token
  const savedToken = localStorage.getItem('strava_token');
  if (savedToken) {
    accessToken = savedToken;
    document.getElementById('auth-section').style.display = 'none';
    loadDashboard();
  }
};

// ─── Auth ─────────────────────────────────────────────────────────────────────
function startAuth() {
  const id = document.getElementById('client-id').value.trim();
  const secret = document.getElementById('client-secret').value.trim();
  const err = document.getElementById('auth-error');

  if (!id || !secret) {
    err.textContent = 'Please enter both Client ID and Client Secret.';
    err.style.display = 'block';
    return;
  }

  localStorage.setItem('strava_creds', JSON.stringify({ id, secret }));

  const redirect = window.location.href.split('?')[0];
  const scope = 'read,activity:read_all';
  const url = `https://www.strava.com/oauth/authorize?client_id=${id}&redirect_uri=${encodeURIComponent(redirect)}&response_type=code&approval_prompt=force&scope=${scope}`;
  window.location.href = url;
}

async function exchangeToken() {
  const id = document.getElementById('t-client-id').value.trim();
  const secret = document.getElementById('t-client-secret').value.trim();
  const code = document.getElementById('t-auth-code').value.trim();
  const err = document.getElementById('token-error');

  if (!id || !secret || !code) {
    err.textContent = 'All fields are required.';
    err.style.display = 'block';
    return;
  }

  showLoading('EXCHANGING AUTHORIZATION CODE');

  try {
    const resp = await fetch('https://www.strava.com/oauth/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ client_id: id, client_secret: secret, code, grant_type: 'authorization_code' })
    });

    if (!resp.ok) throw new Error(`Token exchange failed: ${resp.status}`);
    const data = await resp.json();

    if (!data.access_token) throw new Error(data.message || 'No access token returned');

    accessToken = data.access_token;
    localStorage.setItem('strava_token', data.access_token);
    // Save refresh token and expiry for silent re-auth
    if (data.refresh_token) localStorage.setItem('strava_refresh_token', data.refresh_token);
    if (data.expires_at) localStorage.setItem('strava_token_expiry', data.expires_at);
    // Save client creds for refresh flow
    localStorage.setItem('strava_creds', JSON.stringify({ id, secret }));

    // Clear URL params
    window.history.replaceState({}, document.title, window.location.pathname);

    document.getElementById('token-section').style.display = 'none';
    await loadDashboard();
  } catch (e) {
    hideLoading();
    err.textContent = e.message;
    err.style.display = 'block';
  }
}

// ─── Load Dashboard ───────────────────────────────────────────────────────────
async function loadDashboard() {
  showLoading('CONNECTING TO STRAVA API');

  try {
    // Silent token refresh if expired
    const expiry = parseInt(localStorage.getItem('strava_token_expiry') || '0');
    const now = Math.floor(Date.now() / 1000);
    if (expiry && now >= expiry - 300) {
      // Token expired or expiring in 5 mins — refresh silently
      const creds = JSON.parse(localStorage.getItem('strava_creds') || '{}');
      const refreshToken = localStorage.getItem('strava_refresh_token');
      if (creds.id && creds.secret && refreshToken) {
        setLoadStatus('REFRESHING SESSION...');
        const r = await fetch('https://www.strava.com/oauth/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ client_id: creds.id, client_secret: creds.secret, refresh_token: refreshToken, grant_type: 'refresh_token' })
        });
        if (r.ok) {
          const d = await r.json();
          accessToken = d.access_token;
          localStorage.setItem('strava_token', d.access_token);
          if (d.refresh_token) localStorage.setItem('strava_refresh_token', d.refresh_token);
          if (d.expires_at) localStorage.setItem('strava_token_expiry', d.expires_at);
        }
      }
    }
    // Fetch athlete
    setLoadStatus('FETCHING ATHLETE PROFILE');
    const athleteResp = await fetch('https://www.strava.com/api/v3/athlete', {
      headers: { Authorization: `Bearer ${accessToken}` }
    });
    if (!athleteResp.ok) throw new Error('Failed to fetch athlete. Token may be expired.');
    athleteData = await athleteResp.json();

    // Fetch ALL activities (paginated)
    setLoadStatus('LOADING ALL ACTIVITIES — THIS MAY TAKE A MOMENT');
    allActivities = await fetchAllActivities();

    // Filter runs only
    allActivities = allActivities.filter(a => a.type === 'Run' || a.sport_type === 'Run');

    setLoadStatus('COMPUTING INSIGHTS');
    hideLoading();

    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('tab-nav').style.display = 'flex';
    renderDashboard();

    // Trigger AI insight and temp analysis
    setTimeout(getInsight, 800);
    setTimeout(loadTempAnalysis, 1200);
  } catch (e) {
    hideLoading();
    document.getElementById('auth-section').style.display = 'flex';
    alert('Error: ' + e.message + '\n\nYour session may have expired. Please reconnect.');
    localStorage.removeItem('strava_token');
    localStorage.removeItem('strava_token_expiry');
    localStorage.removeItem('strava_refresh_token');
  }
}

async function fetchAllActivities() {
  const all = [];
  let page = 1;
  while (true) {
    const resp = await fetch(
      `https://www.strava.com/api/v3/athlete/activities?per_page=200&page=${page}`,
      { headers: { Authorization: `Bearer ${accessToken}` } }
    );
    if (!resp.ok) break;
    const batch = await resp.json();
    if (!batch.length) break;
    all.push(...batch);
    page++;
    if (batch.length < 200) break;
  }
  return all;
}

// ─── Filter ───────────────────────────────────────────────────────────────────
function getFilteredRuns() {
  const period = document.getElementById('period-filter')?.value || 'all';
  const now = new Date();
  let cutoff = null;

  if (period === 'all') return allActivities;

  if (period === 'thisweek') {
    // Monday of current week
    const day = now.getDay(); // 0=Sun
    const diff = (day === 0 ? -6 : 1 - day);
    cutoff = new Date(now);
    cutoff.setDate(now.getDate() + diff);
    cutoff.setHours(0, 0, 0, 0);
  } else if (period === 'week') {
    cutoff = new Date(now - 7 * 24 * 60 * 60 * 1000);
  } else if (period === 'month') {
    cutoff = new Date(now - 30 * 24 * 60 * 60 * 1000);
  } else if (period === 'year') {
    cutoff = new Date(now - 365 * 24 * 60 * 60 * 1000);
  } else if (period === 'ytd') {
    cutoff = new Date(now.getFullYear(), 0, 1); // Jan 1 this year
  }

  return allActivities.filter(a => new Date(a.start_date) >= cutoff);
}

function applyFilter() {
  const filtered = getFilteredRuns();
  const period = document.getElementById('period-filter').value;
  const label = period === 'all' ? 'all time' : `${filtered.length} runs in period`;
  document.getElementById('filter-count').textContent = `${filtered.length} runs`;
  renderStats(filtered);
  renderMonthChart(filtered);
  renderRecentActivities(filtered.slice(0, 10));
  renderBestEfforts(filtered);
}

// ─── Render ───────────────────────────────────────────────────────────────────
function renderDashboard() {
  const runs = allActivities;

  // Athlete header
  document.getElementById('athlete-name').textContent =
    `${athleteData.firstname} ${athleteData.lastname}`.toUpperCase();
  document.getElementById('athlete-meta').textContent =
    `${athleteData.city || ''} ${athleteData.country || ''} · ${runs.length} runs loaded`.trim();
  document.getElementById('last-updated').textContent =
    'SYNCED ' + new Date().toLocaleString().toUpperCase();
  document.getElementById('filter-count').textContent = `${runs.length} runs`;

  renderStats(runs);
  renderMonthChart(runs);
  renderRecentActivities(runs.slice(0, 10));
  renderBestEfforts(runs);
  renderRunMap(runs[0]);
}

function renderStats(runs) {
  if (!runs.length) {
    document.getElementById('stat-count').textContent = '0';
    document.getElementById('stat-dist').textContent = '0';
    document.getElementById('stat-elev').textContent = '0';
    document.getElementById('stat-time').textContent = '0';
    document.getElementById('stat-pace').textContent = '—';
    document.getElementById('stat-longest').textContent = '0';
    return;
  }

  // Aggregate stats — miles
  const KM_TO_MI = 0.621371;
  const M_TO_FT = 3.28084;
  const totalDistMi = runs.reduce((s, a) => s + a.distance, 0) / 1000 * KM_TO_MI;
  const totalElev = runs.reduce((s, a) => s + (a.total_elevation_gain || 0), 0) * M_TO_FT;
  const totalTime = runs.reduce((s, a) => s + a.moving_time, 0);
  const longestRun = Math.max(...runs.map(a => a.distance)) / 1000 * KM_TO_MI;

  // Avg pace (min/mile)
  const totalDistM = runs.reduce((s, a) => s + a.distance, 0);
  const totalDistMiles = totalDistM / 1609.344;
  const avgPaceSec = totalDistMiles > 0 ? (totalTime / totalDistMiles) : 0;
  const avgPaceMin = Math.floor(avgPaceSec / 60);
  const avgPaceSec2 = Math.round(avgPaceSec % 60);

  document.getElementById('stat-count').textContent = runs.length;
  document.getElementById('stat-dist').textContent = totalDistMi.toFixed(0);
  document.getElementById('stat-elev').textContent = totalElev.toFixed(0);
  document.getElementById('stat-time').textContent = (totalTime / 3600).toFixed(0);
  document.getElementById('stat-pace').textContent =
    avgPaceSec > 0 ? `${avgPaceMin}:${String(avgPaceSec2).padStart(2,'0')}` : '—';
  document.getElementById('stat-longest').textContent = longestRun.toFixed(1);
}

function renderMonthChart(runs) {
  const months = {};
  runs.forEach(r => {
    const d = new Date(r.start_date);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    months[key] = (months[key] || 0) + (r.distance / 1609.344);
  });

  const sorted = Object.entries(months).sort((a,b) => a[0].localeCompare(b[0]));
  const recent = sorted.slice(-12);
  const maxVal = Math.max(...recent.map(m => m[1]));

  const container = document.getElementById('month-bars');
  container.innerHTML = '';

  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  recent.forEach(([key, val]) => {
    const [yr, mo] = key.split('-');
    const pct = (val / maxVal) * 100;
    const wrap = document.createElement('div');
    wrap.className = 'bar-wrap';
    wrap.title = `${monthNames[parseInt(mo)-1]} ${yr}: ${val.toFixed(1)} mi`;
    wrap.innerHTML = `
      <div class="bar" style="height:${pct}%"></div>
      <div class="bar-label">${monthNames[parseInt(mo)-1]}</div>
    `;
    container.appendChild(wrap);
  });
}

function renderRecentActivities(runs) {
  const container = document.getElementById('activity-list');
  container.innerHTML = '';

  runs.forEach(r => {
    const distMi = (r.distance / 1609.344).toFixed(2);
    const pace = r.distance > 0
      ? (() => {
          const miles = r.distance / 1609.344;
          const s = r.moving_time / miles;
          return `${Math.floor(s/60)}:${String(Math.round(s%60)).padStart(2,'0')}/mi`;
        })()
      : '—';
    const date = new Date(r.start_date).toLocaleDateString('en-US', { day:'numeric', month:'short' });

    const el = document.createElement('div');
    el.className = 'activity-item';
    el.innerHTML = `
      <div>
        <div class="activity-name">${r.name}</div>
        <div class="activity-date">${date}</div>
      </div>
      <div class="activity-dist">${distMi}<span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted)">mi</span></div>
      <div class="activity-pace">${pace}</div>
    `;
    container.appendChild(el);
  });
}

function renderBestEfforts(runs) {
  // Approximate best times by grouping distances
  const buckets = {
    '5K': { min: 4.9, max: 5.15 },
    '10K': { min: 9.9, max: 10.15 },
    'Half Marathon': { min: 20.9, max: 21.5 },
    'Marathon': { min: 41.8, max: 42.5 }
  };

  const prs = {};
  runs.forEach(r => {
    const dist = r.distance / 1000;
    Object.entries(buckets).forEach(([label, range]) => {
      if (dist >= range.min && dist <= range.max) {
        if (!prs[label] || r.moving_time < prs[label].time) {
          prs[label] = { time: r.moving_time, date: r.start_date };
        }
      }
    });
  });

  const container = document.getElementById('pr-grid');

  // Also find longest and fastest short runs
  if (Object.keys(prs).length === 0) {
    container.innerHTML = '<div style="font-family:\'DM Mono\',monospace;font-size:12px;color:var(--muted);grid-column:1/-1;">No standard race distances found in your history. Try filtering shorter or longer runs!</div>';
    return;
  }

  container.innerHTML = '';
  Object.entries(prs).forEach(([dist, data]) => {
    const h = Math.floor(data.time / 3600);
    const m = Math.floor((data.time % 3600) / 60);
    const s = data.time % 60;
    const timeStr = h > 0
      ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`
      : `${m}:${String(s).padStart(2,'0')}`;
    const dateStr = new Date(data.date).toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' });

    const el = document.createElement('div');
    el.className = 'pr-item';
    el.innerHTML = `
      <div class="pr-dist">${dist}</div>
      <div class="pr-time">${timeStr}</div>
      <div class="pr-date">Best — ${dateStr}</div>
    `;
    container.appendChild(el);
  });
}

// ─── Claude AI Insight ────────────────────────────────────────────────────────
async function getInsight() {
  const btn = document.getElementById('insight-btn');
  const textEl = document.getElementById('insight-text');
  btn.style.display = 'none';
  textEl.innerHTML = '<div class="insight-loading"><div class="spinner"></div>Analysing your physical data with Claude AI...</div>';

  // Build summary for Claude
  const runs = allActivities;
  const totalDistMi = (runs.reduce((s, a) => s + a.distance, 0) / 1609.344).toFixed(1);
  const totalRuns = runs.length;
  const avgDistMi = (totalDistMi / totalRuns).toFixed(1);

  const monthlyData = {};
  runs.forEach(r => {
    const d = new Date(r.start_date);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    monthlyData[key] = (monthlyData[key] || 0) + r.distance / 1609.344;
  });
  const recentMonths = Object.entries(monthlyData).sort((a,b) => a[0].localeCompare(b[0])).slice(-6);

  const paceData = runs.filter(r => r.distance > 0).map(r => ({
    dist: (r.distance/1609.344).toFixed(2),
    pace: (r.moving_time / (r.distance / 1609.344)).toFixed(0),
    date: r.start_date.slice(0,10)
  })).slice(-20);

  const prompt = `You are a world-class running coach and data analyst. Analyse this athlete's running data and provide a sharp, insightful 3-4 paragraph analysis. Be specific, reference numbers, and give one actionable recommendation.

Athlete: ${athleteData.firstname} ${athleteData.lastname}
Total runs: ${totalRuns}
Total distance: ${totalDistMi} miles
Average run distance: ${avgDistMi} miles

Monthly distances (last 6 months):
${recentMonths.map(([k,v]) => `${k}: ${v.toFixed(1)} miles`).join('\n')}

Recent 20 runs (date, distance miles, pace sec/mile):
${paceData.map(r => `${r.date}: ${r.dist}mi @ ${Math.floor(r.pace/60)}:${String(r.pace%60).padStart(2,'0')}/mi`).join('\n')}

Provide coaching insights on: training volume trends, pace consistency, progression, and one specific actionable tip. Be direct and data-driven. No generic advice.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    const data = await response.json();
    const text = data.content?.[0]?.text || 'Unable to generate insight.';
    textEl.textContent = text;
    btn.style.display = 'inline-block';
  } catch (e) {
    textEl.textContent = 'AI insight unavailable — Claude API could not be reached. Your dashboard data is still fully functional above.';
    btn.style.display = 'inline-block';
  }
}

// ─── Tab Switching ────────────────────────────────────────────────────────────
let heatmapInitialized = false;
let apihealthInitialized = false;

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');

  ['dashboard','heatmap-tab','anomaly-tab','apihealth-tab','goals-tab'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });

  if (tab === 'dashboard') {
    document.getElementById('dashboard').style.display = 'block';
    if (leafletMap) setTimeout(() => leafletMap.invalidateSize(), 100);
  } else if (tab === 'heatmap') {
    document.getElementById('heatmap-tab').style.display = 'block';
    requestAnimationFrame(() => requestAnimationFrame(() => {
      if (!heatmapInitialized) { heatmapInitialized = true; renderHeatmap(); }
      else if (heatLeafletMap) heatLeafletMap.invalidateSize(true);
    }));
  } else if (tab === 'anomaly') {
    document.getElementById('anomaly-tab').style.display = 'block';
  } else if (tab === 'apihealth') {
    document.getElementById('apihealth-tab').style.display = 'block';
    if (!apihealthInitialized) { apihealthInitialized = true; runHealthCheck(); }
  } else if (tab === 'goals') {
    document.getElementById('goals-tab').style.display = 'block';
    if (!document.getElementById('goal-date').value) {
      const d = new Date(); d.setMonth(d.getMonth() + 6);
      document.getElementById('goal-date').value = d.toISOString().slice(0,10);
    }
  }
}

// ─── Anomaly Detector ─────────────────────────────────────────────────────────
async function runAnomalyDetection() {
  const btn = document.getElementById('anomaly-run-btn');
  const loading = document.getElementById('anomaly-loading');
  const results = document.getElementById('anomaly-results');
  const empty = document.getElementById('anomaly-empty');

  btn.disabled = true;
  loading.style.display = 'flex';
  results.innerHTML = '';
  empty.style.display = 'none';

  const runs = allActivities.slice(0, 30).filter(r => r.distance > 500);

  // Build run summary for Claude
  const runSummary = runs.map((r, i) => {
    const distMi = (r.distance / 1609.344).toFixed(2);
    const paceSec = r.moving_time / (r.distance / 1609.344);
    const paceStr = `${Math.floor(paceSec/60)}:${String(Math.round(paceSec%60)).padStart(2,'0')}`;
    const elevFt = (r.total_elevation_gain * 3.28084).toFixed(0);
    const hr = r.average_heartrate ? `${r.average_heartrate}bpm` : 'no HR';
    return `Run ${i+1}: ${r.start_date.slice(0,10)} | "${r.name}" | ${distMi}mi | ${paceStr}/mi | ${elevFt}ft gain | ${hr}`;
  }).join('\n');

  // Compute baseline stats for context
  const paces = runs.map(r => r.moving_time / (r.distance / 1609.344));
  const avgPace = paces.reduce((s,p) => s+p, 0) / paces.length;
  const avgDist = runs.reduce((s,r) => s + r.distance/1609.344, 0) / runs.length;

  document.getElementById('anomaly-status').textContent = 'Claude AI scanning for anomalies...';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1500,
        messages: [{
          role: 'user',
          content: `You are an AI sensor monitoring system for a physical activity platform. Analyse these 30 runs from athlete ${athleteData.firstname} ${athleteData.lastname} and identify anomalies — unusual patterns that deviate significantly from their baseline.

Baseline: avg pace ${Math.floor(avgPace/60)}:${String(Math.round(avgPace%60)).padStart(2,'0')}/mi, avg distance ${avgDist.toFixed(1)}mi

Run data:
${runSummary}

Identify 3-5 specific anomalies. For each, respond in this EXACT format:
ANOMALY: [short title]
SEVERITY: [LOW|MEDIUM|HIGH]
RUN: [run number and date]
DETAIL: [specific observation with numbers]
INSIGHT: [what this might indicate]
---

Be precise and data-driven. Reference actual numbers. Flag things like: sudden pace drops/gains (>15% deviation), unusual distances, back-to-back hard efforts, suspicious HR readings, dramatic elevation changes.`
        }]
      })
    });

    const data = await response.json();
    const text = data.content?.[0]?.text || '';
    loading.style.display = 'none';
    btn.disabled = false;

    // Parse anomalies
    const anomalies = text.split('---').map(s => s.trim()).filter(Boolean);
    if (!anomalies.length) {
      empty.textContent = 'No significant anomalies detected in your last 30 runs.';
      empty.style.display = 'block';
      return;
    }

    anomalies.forEach(block => {
      const get = key => { const m = block.match(new RegExp(key + ': (.+)')); return m ? m[1].trim() : ''; };
      const title = get('ANOMALY');
      const severity = get('SEVERITY');
      const run = get('RUN');
      const detail = get('DETAIL');
      const insight = get('INSIGHT');
      if (!title) return;

      const severityColor = severity === 'HIGH' ? '#ff2200' : severity === 'MEDIUM' ? '#ff8800' : '#ffcc00';
      const card = document.createElement('div');
      card.className = 'panel';
      card.style.marginBottom = '16px';
      card.style.borderLeft = `3px solid ${severityColor}`;
      card.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
          <span style="font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:${severityColor};border:1px solid ${severityColor};padding:2px 8px;border-radius:3px;">${severity}</span>
          <span style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1px;">${title}</span>
          <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);margin-left:auto;">${run}</span>
        </div>
        <p style="font-size:13px;color:var(--text);margin-bottom:8px;line-height:1.6;">${detail}</p>
        <p style="font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);line-height:1.6;">↳ ${insight}</p>
      `;
      results.appendChild(card);
    });

  } catch(e) {
    loading.style.display = 'none';
    btn.disabled = false;
    empty.textContent = 'Analysis failed: ' + e.message;
    empty.style.display = 'block';
  }
}

// ─── API Health Monitor ───────────────────────────────────────────────────────
const requestLog = [];

async function runHealthCheck() {
  const endpoints = [
    { name: 'Athlete Profile', url: 'https://www.strava.com/api/v3/athlete', method: 'GET' },
    { name: 'Activities List', url: 'https://www.strava.com/api/v3/athlete/activities?per_page=1', method: 'GET' },
    { name: 'Athlete Stats', url: `https://www.strava.com/api/v3/athletes/${athleteData?.id}/stats`, method: 'GET' },
    { name: 'Starred Segments', url: 'https://www.strava.com/api/v3/segments/starred', method: 'GET' },
  ];

  const results = [];
  for (const ep of endpoints) {
    const start = performance.now();
    let status = 'OK', statusCode = 200, rateLimitUsage = null, rateLimitLimit = null;
    try {
      const resp = await fetch(ep.url, { headers: { Authorization: `Bearer ${accessToken}` } });
      const elapsed = Math.round(performance.now() - start);
      statusCode = resp.status;
      status = resp.ok ? 'OK' : 'ERROR';
      rateLimitUsage = resp.headers.get('X-RateLimit-Usage');
      rateLimitLimit = resp.headers.get('X-RateLimit-Limit');
      results.push({ name: ep.name, elapsed, status, statusCode, rateLimitUsage, rateLimitLimit });
      requestLog.unshift({ time: new Date().toLocaleTimeString(), name: ep.name, elapsed, status: statusCode });
    } catch(e) {
      const elapsed = Math.round(performance.now() - start);
      results.push({ name: ep.name, elapsed, status: 'FAIL', statusCode: 0, rateLimitUsage, rateLimitLimit });
      requestLog.unshift({ time: new Date().toLocaleTimeString(), name: ep.name, elapsed, status: 'ERR' });
    }
  }

  // Keep log to 20 entries
  requestLog.splice(20);

  // Summary cards
  const avgTime = Math.round(results.reduce((s,r) => s+r.elapsed,0) / results.length);
  const successRate = Math.round((results.filter(r=>r.status==='OK').length / results.length)*100);
  const fastest = Math.min(...results.map(r=>r.elapsed));
  const slowest = Math.max(...results.map(r=>r.elapsed));

  document.getElementById('health-grid').innerHTML = `
    <div class="stat-card"><div class="stat-label">AVG RESPONSE</div><div class="stat-value" style="font-size:36px;color:${avgTime<500?'var(--green)':avgTime<1000?'#ffcc00':'#ff4444'}">${avgTime}<span style="font-size:16px;font-family:var(--mono)">ms</span></div></div>
    <div class="stat-card"><div class="stat-label">SUCCESS RATE</div><div class="stat-value" style="font-size:36px;color:${successRate===100?'var(--green)':'#ff4444'}">${successRate}<span style="font-size:16px;font-family:var(--mono)">%</span></div></div>
    <div class="stat-card"><div class="stat-label">FASTEST</div><div class="stat-value" style="font-size:36px">${fastest}<span style="font-size:16px;font-family:var(--mono)">ms</span></div></div>
    <div class="stat-card"><div class="stat-label">SLOWEST</div><div class="stat-value" style="font-size:36px">${slowest}<span style="font-size:16px;font-family:var(--mono)">ms</span></div></div>
  `;

  // Endpoint list
  document.getElementById('endpoint-list').innerHTML = results.map(r => `
    <div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);">
      <div style="width:8px;height:8px;border-radius:50%;background:${r.status==='OK'?'var(--green)':'#ff4444'};flex-shrink:0;"></div>
      <div style="flex:1;font-size:13px;">${r.name}</div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--muted);">HTTP ${r.statusCode}</div>
      <div style="font-family:var(--mono);font-size:13px;color:${r.elapsed<500?'var(--green)':r.elapsed<1000?'#ffcc00':'#ff4444'};min-width:60px;text-align:right;">${r.elapsed}ms</div>
    </div>
  `).join('');

  // Request log
  document.getElementById('request-log').innerHTML = requestLog.map(r => `
    <div style="display:flex;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);font-family:var(--mono);font-size:10px;">
      <span style="color:var(--muted);min-width:70px;">${r.time}</span>
      <span style="flex:1;color:var(--text);">${r.name}</span>
      <span style="color:${r.status===200?'var(--green)':'#ff4444'};">${r.status}</span>
      <span style="color:var(--muted);min-width:50px;text-align:right;">${r.elapsed}ms</span>
    </div>
  `).join('');

  // Rate limits — from last result that has them
  const withLimits = results.find(r => r.rateLimitUsage);
  if (withLimits?.rateLimitUsage) {
    const [usage15, usageDay] = withLimits.rateLimitUsage.split(',').map(Number);
    const [limit15, limitDay] = (withLimits.rateLimitLimit || '100,1000').split(',').map(Number);
    const pct15 = Math.round((usage15/limit15)*100);
    const pctDay = Math.round((usageDay/limitDay)*100);
    document.getElementById('rate-limit-display').innerHTML = `
      <div style="margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;color:var(--muted);margin-bottom:6px;"><span>15-MIN WINDOW</span><span>${usage15} / ${limit15} requests (${pct15}%)</span></div>
        <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden;"><div style="height:100%;width:${pct15}%;background:${pct15<70?'var(--green)':pct15<90?'#ffcc00':'#ff4444'};border-radius:3px;transition:width 0.5s;"></div></div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:11px;color:var(--muted);margin-bottom:6px;"><span>DAILY LIMIT</span><span>${usageDay} / ${limitDay} requests (${pctDay}%)</span></div>
        <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden;"><div style="height:100%;width:${pctDay}%;background:${pctDay<70?'var(--green)':pctDay<90?'#ffcc00':'#ff4444'};border-radius:3px;transition:width 0.5s;"></div></div>
      </div>
    `;
  } else {
    document.getElementById('rate-limit-display').innerHTML = `<span style="font-family:var(--mono);font-size:11px;color:var(--muted);">Rate limit headers not exposed by Strava CORS — within normal limits.</span>`;
  }
}

// ─── Goal Tracker ─────────────────────────────────────────────────────────────
let goalCharts = {};

async function calculateGoal() {
  const distKm = parseFloat(document.getElementById('goal-distance').value);
  const goalDate = document.getElementById('goal-date').value;
  const targetRaw = document.getElementById('goal-target').value.trim();

  if (!goalDate) { alert('Please set a goal date.'); return; }

  const distanceLabels = { 5:'5K', 10:'10K', 21.1:'Half Marathon', 42.2:'Marathon' };
  const label = distanceLabels[distKm] || `${distKm}km`;
  const distMi = distKm * 0.621371;

  // Get last 20 runs for pace trend
  const recent = allActivities.slice(0, 20).filter(r => r.distance > 1000);
  const paces = recent.map(r => r.moving_time / (r.distance / 1609.344));
  const avgPaceSec = paces.reduce((s,p)=>s+p,0) / paces.length;

  // Simple pace trend — linear regression
  const n = paces.length;
  const xs = paces.map((_,i) => i);
  const meanX = xs.reduce((s,x)=>s+x,0)/n;
  const meanY = avgPaceSec;
  const slope = xs.reduce((s,x,i)=>s+(x-meanX)*(paces[i]-meanY),0) / xs.reduce((s,x)=>s+(x-meanX)**2,0);
  // Project pace improvement per week (assuming ~3 runs/week)
  const weeksToGoal = Math.max(1, Math.round((new Date(goalDate) - new Date()) / (7*24*60*60*1000)));
  const runsToGoal = weeksToGoal * 3;
  const projectedPaceSec = Math.max(avgPaceSec + slope * runsToGoal, avgPaceSec * 0.85); // cap at 15% improvement
  const projectedFinishSec = projectedPaceSec * distMi;

  const fmtTime = secs => {
    const h = Math.floor(secs/3600);
    const m = Math.floor((secs%3600)/60);
    const s = Math.round(secs%60);
    return h > 0 ? `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` : `${m}:${String(s).padStart(2,'0')}`;
  };

  // Parse target time if given
  let targetSec = null;
  if (targetRaw) {
    const parts = targetRaw.split(':').map(Number);
    targetSec = parts.length===3 ? parts[0]*3600+parts[1]*60+parts[2] : parts[0]*60+parts[1];
  }

  const gapSec = targetSec ? targetSec - projectedFinishSec : null;

  // Weekly mileage
  const weeklyMiles = {};
  allActivities.slice(0, 200).forEach(r => {
    const d = new Date(r.start_date);
    const week = `${d.getFullYear()}-W${String(Math.ceil(d.getDate()/7)).padStart(2,'0')}`;
    weeklyMiles[week] = (weeklyMiles[week]||0) + r.distance/1609.344;
  });
  const recentWeeks = Object.entries(weeklyMiles).sort((a,b)=>a[0].localeCompare(b[0])).slice(-12);
  const avgWeeklyMi = recentWeeks.reduce((s,[,v])=>s+v,0)/recentWeeks.length;

  // Stats
  document.getElementById('goal-stats').innerHTML = `
    <div class="stat-card"><div class="stat-label">GOAL</div><div class="stat-value" style="font-size:28px">${label}</div><div class="stat-unit">${goalDate}</div></div>
    <div class="stat-card"><div class="stat-label">WEEKS TO RACE</div><div class="stat-value" style="font-size:36px">${weeksToGoal}</div><div class="stat-unit">weeks away</div></div>
    <div class="stat-card"><div class="stat-label">PROJECTED FINISH</div><div class="stat-value" style="font-size:28px">${fmtTime(projectedFinishSec)}</div><div class="stat-unit">at current trend</div></div>
    <div class="stat-card"><div class="stat-label">${targetSec ? 'GAP TO TARGET' : 'CURRENT PACE'}</div><div class="stat-value" style="font-size:28px;color:${gapSec===null?'var(--text)':gapSec>0?'var(--green)':'#ff4444'}">${targetSec ? (gapSec>0?'+':'')+fmtTime(Math.abs(gapSec)) : fmtTime(avgPaceSec)+'/mi'}</div><div class="stat-unit">${targetSec?(gapSec>0?'ahead of target':'behind target'):'average pace'}</div></div>
    <div class="stat-card"><div class="stat-label">AVG WEEKLY MILES</div><div class="stat-value" style="font-size:36px">${avgWeeklyMi.toFixed(0)}</div><div class="stat-unit">miles/week</div></div>
  `;

  document.getElementById('goal-results').style.display = 'block';

  // Destroy old charts
  Object.values(goalCharts).forEach(c => c.destroy());
  goalCharts = {};

  const chartOpts = {
    plugins: { legend: { display: false } },
    scales: {
      x: { grid:{color:'#2a2a2a'}, ticks:{color:'#666',font:{family:'DM Mono',size:10}} },
      y: { grid:{color:'#2a2a2a'}, ticks:{color:'#666',font:{family:'DM Mono',size:10}} }
    }
  };

  // Pace trend chart
  goalCharts.pace = new Chart(document.getElementById('pace-trend-chart'), {
    type: 'line',
    data: {
      labels: recent.map(r => r.start_date.slice(5,10)).reverse(),
      datasets: [{
        data: [...paces].reverse(),
        borderColor: '#FC4C02',
        backgroundColor: 'rgba(252,76,2,0.1)',
        tension: 0.3, fill: true, pointRadius: 4, pointBackgroundColor: '#FC4C02'
      }]
    },
    options: { ...chartOpts, scales: { ...chartOpts.scales, y: { ...chartOpts.scales.y, reverse: true, ticks: { ...chartOpts.scales.y.ticks, callback: v => `${Math.floor(v/60)}:${String(Math.round(v%60)).padStart(2,'0')}` } } } }
  });

  // Weekly mileage chart
  goalCharts.weekly = new Chart(document.getElementById('weekly-chart'), {
    type: 'bar',
    data: {
      labels: recentWeeks.map(([k]) => k.slice(5)),
      datasets: [{ data: recentWeeks.map(([,v]) => +v.toFixed(1)), backgroundColor: 'rgba(252,76,2,0.7)', borderRadius: 3 }]
    },
    options: chartOpts
  });

  // AI training plan
  const aiEl = document.getElementById('goal-ai-text');
  aiEl.innerHTML = '<div class="insight-loading"><div class="spinner"></div>Generating training plan...</div>';

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 800,
        messages: [{
          role: 'user',
          content: `You are an elite running coach. Give a concise, specific training recommendation for this athlete:

Athlete: ${athleteData.firstname} ${athleteData.lastname}
Goal: ${label} on ${goalDate} (${weeksToGoal} weeks away)
${targetSec ? `Target time: ${fmtTime(targetSec)}` : ''}
Current avg pace: ${fmtTime(avgPaceSec)}/mile
Projected finish: ${fmtTime(projectedFinishSec)}
${gapSec !== null ? `Gap to target: ${gapSec>0?'ahead by':'behind by'} ${fmtTime(Math.abs(gapSec))}` : ''}
Avg weekly mileage: ${avgWeeklyMi.toFixed(0)} miles
Recent pace trend: ${slope < 0 ? 'improving' : slope > 0 ? 'slowing' : 'flat'} (${Math.abs(slope).toFixed(1)}s/run)

Give 3-4 sentences of specific, actionable advice on: weekly mileage targets, key workouts to focus on, and one warning or risk to watch for. Be direct and use specific numbers.`
        }]
      })
    });
    const d = await resp.json();
    aiEl.textContent = d.content?.[0]?.text || 'Could not generate plan.';
  } catch(e) {
    aiEl.textContent = 'AI training plan unavailable.';
  }
}

// ─── Heatmap ──────────────────────────────────────────────────────────────────
let heatLeafletMap = null;

async function renderHeatmap() {
  const runs = allActivities.slice(0, 100);
  const totalRuns = runs.length;
  let processed = 0;

  const updateProgress = (pct, msg) => {
    document.getElementById('heat-progress-fill').style.width = pct + '%';
    document.getElementById('heat-status').textContent = msg;
  };

  updateProgress(5, 'Initialising map...');

  // Init Leaflet map — default Austin view
  if (heatLeafletMap) { heatLeafletMap.remove(); heatLeafletMap = null; }
  heatLeafletMap = L.map('heatmap', { zoomControl: true, scrollWheelZoom: true });
  heatLeafletMap.setView([30.2607, -97.7382], 14);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors', maxZoom: 19
  }).addTo(heatLeafletMap);

  // Count how many times each route segment is used for colour intensity
  const freqMap = {};
  const allCoords = [];

  for (const run of runs) {
    const poly = run.map?.summary_polyline;
    if (!poly) { processed++; continue; }
    const coords = decodePolyline(poly);
    allCoords.push(coords);
    // Count point frequency at coarse grid for colour weighting
    coords.forEach(([lat, lng]) => {
      const key = `${lat.toFixed(3)},${lng.toFixed(3)}`;
      freqMap[key] = (freqMap[key] || 0) + 1;
    });
    processed++;
    updateProgress(5 + Math.round((processed / totalRuns) * 70), `Decoded ${processed}/${totalRuns} routes...`);
  }

  updateProgress(80, 'Drawing routes...');

  const maxFreq = Math.max(...Object.values(freqMap), 1);

  // Draw each run as a polyline, colour by average frequency
  allCoords.forEach((coords) => {
    if (!coords.length) return;
    // Sample midpoint to determine colour
    const mid = coords[Math.floor(coords.length / 2)];
    const key = `${mid[0].toFixed(3)},${mid[1].toFixed(3)}`;
    const freq = freqMap[key] || 1;
    const w = freq / maxFreq;

    const color = w > 0.6 ? '#ff2200'
                : w > 0.3 ? '#ff8800'
                : w > 0.1 ? '#ffcc00'
                :            '#FC4C02';

    const opacity = 0.25 + w * 0.5;

    L.polyline(coords, {
      color,
      weight: 2.5,
      opacity,
      lineJoin: 'round',
      lineCap: 'round'
    }).addTo(heatLeafletMap);
  });

  updateProgress(100, 'Done!');

  setTimeout(() => {
    document.getElementById('heatmap-loading').style.display = 'none';
    document.getElementById('heatmap-overlay').style.display = 'block';
    heatLeafletMap.invalidateSize(true);

    // Fit to all routes
    const allLatLngs = allCoords.flat();
    if (allLatLngs.length > 0) {
      const lats = allLatLngs.map(p => p[0]);
      const lngs = allLatLngs.map(p => p[1]);
      heatLeafletMap.fitBounds(
        [[Math.min(...lats), Math.min(...lngs)], [Math.max(...lats), Math.max(...lngs)]],
        { padding: [60, 60] }
      );
    }

    const totalMi = (runs.reduce((s,r) => s + r.distance, 0) / 1609.344).toFixed(0);
    document.getElementById('heat-stats').innerHTML = `
      <div class="heatmap-stat">
        <span class="heatmap-stat-label">RUNS MAPPED</span>
        <span class="heatmap-stat-val">${processed}</span>
      </div>
      <div class="heatmap-stat">
        <span class="heatmap-stat-label">TOTAL MILES</span>
        <span class="heatmap-stat-val">${totalMi}</span>
      </div>
      <div class="heatmap-stat">
        <span class="heatmap-stat-label">ROUTES DRAWN</span>
        <span class="heatmap-stat-val">${allCoords.length}</span>
      </div>
    `;
  }, 400);
}

// ─── Most Recent Run Map ──────────────────────────────────────────────────────
let leafletMap = null;

function decodePolyline(encoded) {
  // Google Polyline Algorithm decoder
  const coords = [];
  let index = 0, lat = 0, lng = 0;
  while (index < encoded.length) {
    let b, shift = 0, result = 0;
    do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
    lat += (result & 1) ? ~(result >> 1) : (result >> 1);
    shift = 0; result = 0;
    do { b = encoded.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
    lng += (result & 1) ? ~(result >> 1) : (result >> 1);
    coords.push([lat / 1e5, lng / 1e5]);
  }
  return coords;
}

function renderRunMap(run) {
  if (!run) return;

  const polyline = run.map?.summary_polyline;
  const meta = document.getElementById('map-meta');
  const distMi = (run.distance / 1609.344).toFixed(2);
  const elev = (run.total_elevation_gain * 3.28084).toFixed(0);
  const paceS = run.distance > 0 ? run.moving_time / (run.distance / 1609.344) : 0;
  const paceStr = paceS > 0 ? `${Math.floor(paceS/60)}:${String(Math.round(paceS%60)).padStart(2,'0')}/mi` : '—';
  const dateStr = new Date(run.start_date).toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });

  meta.innerHTML = `
    <div class="map-stat">
      <div class="map-stat-label">ACTIVITY</div>
      <div style="font-size:15px;font-weight:500;margin-top:2px">${run.name}</div>
      <div class="map-stat-unit">${dateStr}</div>
    </div>
    <div class="map-stat">
      <div class="map-stat-label">DISTANCE</div>
      <div class="map-stat-val">${distMi}<span class="map-stat-unit"> mi</span></div>
    </div>
    <div class="map-stat">
      <div class="map-stat-label">PACE</div>
      <div class="map-stat-val" style="font-size:22px">${paceStr}</div>
    </div>
    <div class="map-stat">
      <div class="map-stat-label">ELEVATION GAIN</div>
      <div class="map-stat-val">${elev}<span class="map-stat-unit"> ft</span></div>
    </div>
  `;

  if (!polyline) {
    document.getElementById('map').innerHTML =
      '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:\'DM Mono\',monospace;font-size:12px;color:var(--muted);">No route data available for this activity</div>';
    return;
  }

  const coords = decodePolyline(polyline);
  if (!coords.length) return;

  // Init or reset map
  if (leafletMap) { leafletMap.remove(); leafletMap = null; }

  leafletMap = L.map('map', { zoomControl: true, scrollWheelZoom: false });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap',
    maxZoom: 18
  }).addTo(leafletMap);

  const route = L.polyline(coords, {
    color: '#FC4C02',
    weight: 4,
    opacity: 0.9,
    lineJoin: 'round'
  }).addTo(leafletMap);

  // Start/end markers
  const startIcon = L.divIcon({
    className: '',
    html: '<div style="width:12px;height:12px;background:#00e5a0;border:2px solid #fff;border-radius:50%;box-shadow:0 0 8px rgba(0,229,160,0.6)"></div>',
    iconSize: [12, 12], iconAnchor: [6, 6]
  });
  const endIcon = L.divIcon({
    className: '',
    html: '<div style="width:12px;height:12px;background:#FC4C02;border:2px solid #fff;border-radius:50%;box-shadow:0 0 8px rgba(252,76,2,0.6)"></div>',
    iconSize: [12, 12], iconAnchor: [6, 6]
  });

  L.marker(coords[0], { icon: startIcon }).addTo(leafletMap);
  L.marker(coords[coords.length - 1], { icon: endIcon }).addTo(leafletMap);

  leafletMap.fitBounds(route.getBounds(), { padding: [24, 24] });
}

// ─── Temperature vs Pace Analysis ─────────────────────────────────────────────
async function loadTempAnalysis() {
  const runs = allActivities.slice(0, 100).filter(r => r.distance > 1000);
  const statusEl = document.getElementById('temp-status');
  const setStatus = msg => { statusEl.textContent = msg; };

  try {
    setStatus('Fetching historical weather from Open-Meteo...');

    // Batch runs by date to minimise API calls
    // Open-Meteo historical API: one call per run location/date
    const runData = [];
    let fetched = 0;

    for (const run of runs) {
      const lat = run.start_latlng?.[0];
      const lng = run.start_latlng?.[1];
      if (!lat || !lng) { fetched++; continue; }

      const date = run.start_date.slice(0, 10);
      const hour = new Date(run.start_date).getUTCHours();

      try {
        const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat.toFixed(3)}&longitude=${lng.toFixed(3)}&start_date=${date}&end_date=${date}&hourly=temperature_2m&temperature_unit=fahrenheit&timezone=America%2FChicago`;
        const resp = await fetch(url);
        const data = await resp.json();
        const temps = data?.hourly?.temperature_2m;
        if (!temps) { fetched++; continue; }

        // Get temp at the hour the run started
        const temp = temps[Math.min(hour, temps.length - 1)];
        const paceSecPerMile = run.moving_time / (run.distance / 1609.344);

        // Filter out obviously bad data (sub 4min or over 20min miles)
        if (paceSecPerMile > 240 && paceSecPerMile < 1200 && temp > -20 && temp < 130) {
          runData.push({
            name: run.name,
            date: run.start_date.slice(0, 10),
            temp: Math.round(temp),
            pace: paceSecPerMile,
            dist: (run.distance / 1609.344).toFixed(1)
          });
        }
      } catch(e) { /* skip failed runs */ }

      fetched++;
      if (fetched % 5 === 0) setStatus(`Fetched weather for ${fetched}/${runs.length} runs...`);

      // Small delay to be respectful to the free API
      await new Promise(r => setTimeout(r, 80));
    }

    if (runData.length < 5) throw new Error('Not enough runs with weather data to analyse.');

    document.getElementById('temp-loading').style.display = 'none';
    document.getElementById('temp-content').style.display = 'block';

    renderTempCharts(runData);

  } catch(e) {
    document.getElementById('temp-loading').style.display = 'none';
    document.getElementById('temp-error').style.display = 'block';
    document.getElementById('temp-error').textContent = 'Could not load weather data: ' + e.message;
  }
}

function paceToStr(secs) {
  const m = Math.floor(secs / 60);
  const s = Math.round(secs % 60);
  return `${m}:${String(s).padStart(2,'0')}`;
}

function renderTempCharts(runData) {
  // Sort by temp
  runData.sort((a, b) => a.temp - b.temp);

  const temps = runData.map(r => r.temp);
  const paces = runData.map(r => r.pace);

  const minTemp = Math.min(...temps);
  const maxTemp = Math.max(...temps);
  const avgPace = paces.reduce((s,p) => s+p, 0) / paces.length;

  // Find optimal temp (best average pace)
  const buckets = {};
  runData.forEach(r => {
    const bucket = Math.floor(r.temp / 10) * 10;
    if (!buckets[bucket]) buckets[bucket] = [];
    buckets[bucket].push(r.pace);
  });
  const bucketAvgs = Object.entries(buckets).map(([t, ps]) => ({
    temp: parseInt(t),
    avgPace: ps.reduce((s,p) => s+p,0) / ps.length,
    count: ps.length
  })).filter(b => b.count >= 2).sort((a,b) => a.temp - b.temp);

  const bestBucket = [...bucketAvgs].sort((a,b) => a.avgPace - b.avgPace)[0];

  // Correlation coefficient
  const n = temps.length;
  const meanT = temps.reduce((s,t)=>s+t,0)/n;
  const meanP = paces.reduce((s,p)=>s+p,0)/n;
  const num = temps.reduce((s,t,i) => s + (t-meanT)*(paces[i]-meanP), 0);
  const den = Math.sqrt(temps.reduce((s,t)=>s+(t-meanT)**2,0) * paces.reduce((s,p)=>s+(p-meanP)**2,0));
  const corr = den > 0 ? (num/den) : 0;

  // Summary stats
  document.getElementById('temp-stats-row').innerHTML = `
    <div class="stat-card" style="padding:16px">
      <div class="stat-label">RUNS ANALYSED</div>
      <div class="stat-value" style="font-size:32px">${runData.length}</div>
    </div>
    <div class="stat-card" style="padding:16px">
      <div class="stat-label">TEMP RANGE</div>
      <div class="stat-value" style="font-size:32px">${minTemp}–${maxTemp}°</div>
      <div class="stat-unit">°F across all runs</div>
    </div>
    <div class="stat-card" style="padding:16px">
      <div class="stat-label">OPTIMAL TEMP</div>
      <div class="stat-value" style="font-size:32px">${bestBucket ? bestBucket.temp + '°' : '—'}</div>
      <div class="stat-unit">°F for best pace</div>
    </div>
    <div class="stat-card" style="padding:16px">
      <div class="stat-label">CORRELATION</div>
      <div class="stat-value" style="font-size:32px">${corr > 0 ? '+' : ''}${corr.toFixed(2)}</div>
      <div class="stat-unit">${Math.abs(corr) > 0.4 ? (corr > 0 ? 'heat slows you down' : 'cold slows you down') : 'weak temp effect'}</div>
    </div>
  `;

  const chartDefaults = {
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { color: '#2a2a2a' }, ticks: { color: '#666', font: { family: 'DM Mono', size: 10 } } },
      y: { grid: { color: '#2a2a2a' }, ticks: { color: '#666', font: { family: 'DM Mono', size: 10 },
        callback: val => paceToStr(val) } }
    }
  };

  // ── Scatter chart ──
  new Chart(document.getElementById('scatter-chart'), {
    type: 'scatter',
    data: {
      datasets: [{
        data: runData.map(r => ({ x: r.temp, y: r.pace, name: r.name, date: r.date, dist: r.dist })),
        backgroundColor: runData.map(r => {
          const t = (r.temp - minTemp) / (maxTemp - minTemp || 1);
          const r2 = Math.round(26 + t * 229);
          const g2 = Math.round(180 - t * 180);
          return `rgba(${r2},${g2},80,0.75)`;
        }),
        pointRadius: 6,
        pointHoverRadius: 9
      }]
    },
    options: {
      ...chartDefaults,
      plugins: {
        ...chartDefaults.plugins,
        tooltip: {
          callbacks: {
            label: ctx => {
              const d = ctx.raw;
              return [`${d.name}`, `${d.date} · ${d.dist}mi`, `${ctx.raw.x}°F · ${paceToStr(ctx.raw.y)}/mi`];
            }
          },
          bodyFont: { family: 'DM Mono', size: 11 },
          backgroundColor: '#1a1a1a',
          borderColor: '#2a2a2a',
          borderWidth: 1
        }
      },
      scales: {
        ...chartDefaults.scales,
        x: { ...chartDefaults.scales.x, title: { display: true, text: 'Temperature (°F)', color: '#666', font: { family: 'DM Mono', size: 10 } } },
        y: { ...chartDefaults.scales.y, title: { display: true, text: 'Pace (min/mi)', color: '#666', font: { family: 'DM Mono', size: 10 } },
          reverse: true }
      }
    }
  });

  // ── Trend / bar chart ──
  new Chart(document.getElementById('trend-chart'), {
    type: 'bar',
    data: {
      labels: bucketAvgs.map(b => `${b.temp}s°F`),
      datasets: [{
        data: bucketAvgs.map(b => b.avgPace),
        backgroundColor: bucketAvgs.map(b => {
          const t = (b.temp - minTemp) / (maxTemp - minTemp || 1);
          return `rgba(252,76,2,${0.4 + t * 0.5})`;
        }),
        borderRadius: 4
      }]
    },
    options: {
      ...chartDefaults,
      scales: {
        ...chartDefaults.scales,
        x: { ...chartDefaults.scales.x, title: { display: true, text: 'Temp Range (°F)', color: '#666', font: { family: 'DM Mono', size: 10 } } },
        y: { ...chartDefaults.scales.y, title: { display: true, text: 'Avg Pace (min/mi)', color: '#666', font: { family: 'DM Mono', size: 10 } },
          reverse: true }
      },
      plugins: {
        ...chartDefaults.plugins,
        tooltip: {
          callbacks: {
            label: ctx => {
              const b = bucketAvgs[ctx.dataIndex];
              return [`Avg pace: ${paceToStr(ctx.raw)}`, `${b.count} runs in range`];
            }
          },
          bodyFont: { family: 'DM Mono', size: 11 },
          backgroundColor: '#1a1a1a',
          borderColor: '#2a2a2a',
          borderWidth: 1
        }
      }
    }
  });

  // Insight text
  const direction = corr > 0.3 ? 'slower in heat' : corr < -0.3 ? 'slower in cold' : 'not strongly affected by temperature';
  const best = bestBucket ? `Your sweet spot is the ${bestBucket.temp}s°F range` : '';
  document.getElementById('temp-insight').textContent =
    `Based on ${runData.length} runs between ${minTemp}°F and ${maxTemp}°F, your pace is ${direction} (r=${corr.toFixed(2)}). ${best}${best ? ', where your average pace is ' + paceToStr(bestBucket.avgPace) + '/mi.' : '.'}`;
}

// ─── Helpers ──────────────────────────────────────────────────────────────────
function logout() {
  localStorage.removeItem('strava_token');
  localStorage.removeItem('strava_token_expiry');
  localStorage.removeItem('strava_refresh_token');
  window.location.reload();
}

function showLoading(msg) {
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('load-status').textContent = msg;
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function setLoadStatus(msg) {
  document.getElementById('load-status').textContent = msg;
}
</script>
</body>
</html>
